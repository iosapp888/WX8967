<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" type="image/x-icon" id="favicon" href="" />
    <meta name="description" id="metaDescription" content="" />
    <title id="pageTitle"></title>
    <meta property="og:title" id="ogTitle" content="" />
    <meta property="og:description" id="ogDescription" content="" />
    <meta property="og:image" id="ogImage" content="" />
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.bootcss.com/bootstrap/4.1.1/css/bootstrap.min.css" rel="stylesheet">
    
    <style type="text/tailwindcss">
        @layer utilities {
            .loader {
                @apply animate-spin h-12 w-12 border-2 border-green-500 border-t-transparent rounded-full;
            }
            .fade-in {
                animation: fadeIn 0.5s ease-in-out;
            }
            .expired-x {
                @apply text-red-600 text-6xl md:text-8xl font-black;
                text-shadow: 0 2px 4px rgba(0,0,0,0.1);
            }
        }
    </style>
    
    <style>
        html, body {
            margin: 0;
            padding: 0;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
        }
        #contentFrame {
            height: 100vh;
            width: 100vw;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .expired-container {
            background: linear-gradient(135deg, #fff 0%, #f9f9f9 100%);
        }
        
        /* 引导模式样式 */
        .guide-mask {
            position: fixed;
            inset: 0;
            background-color: #fff;
            z-index: 50;
            overflow-y: auto;
        }
        .loader-guide {
            width: 320px;
            margin: 50px auto 70px;
            position: relative;
        }
        .loader-guide .loading-1 {
            margin: 0 auto;
            width: 70%;
            height: 10px;
            border: 1px solid #69d2e7;
            border-radius: 10px;
            animation: turn 4s linear 1.75s infinite;
        }
        .loader-guide .loading-1:before {
            content: "";
            display: block;
            width: 0%;
            height: 100%;
            background: #69d2e7;
            box-shadow: 10px 0 15px 0 #69d2e7;
            animation: load 2s linear infinite;
        }
        .loader-guide .loading-2 {
            width: 100%;
            position: absolute;
            top: 20px;
            color: #69d2e7;
            font-size: 22px;
            text-align: center;
            animation: bounce 2s linear infinite;
        }
        @keyframes load { 0% { width: 0%; } 87.5%, 100% { width: 100%; } }
        @keyframes turn { 0% { transform: rotateY(0deg); } 6.25%, 50% { transform: rotateY(180deg); } 56.25%, 100% { transform: rotateY(360deg); } }
        @keyframes bounce { 0%,100% { top: 10px; } 12.5% { top: 30px; } }
    </style>
</head>
<body class="bg-gray-50">
    <!-- 加载状态 -->
    <div id="loaderContainer" class="fixed inset-0 flex flex-col justify-center items-center bg-white z-50">
        <div class="loader mb-4"></div>
        <h1 class="text-xl font-semibold text-gray-800">正在加载内容...</h1>
        <p id="loadProgress" class="text-gray-500 mt-2 text-sm">准备请求资源</p>
    </div>
    
    <!-- 内嵌模式容器 -->
    <div id="contentContainer" class="hidden fade-in">
        <iframe id="contentFrame" class="border-0 w-full h-full" 
                sandbox="allow-same-origin allow-scripts allow-popups allow-forms"
                title="内嵌网页内容"></iframe>
    </div>
    
    <!-- 链接过期页面 -->
    <div id="expiredContainer" class="hidden fixed inset-0 flex flex-col justify-center items-center expired-container z-50 p-6 text-center">
        <div class="expired-x mb-6">✕</div>
        <h3 class="text-2xl font-bold text-gray-800 mb-3">链接已过期</h3>
        <p id="expiryDetail" class="text-gray-600 mb-8 max-w-md">该链接的有效期已过，无法继续访问。请联系链接提供者获取最新链接。</p>
        <button id="closeBtn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-6 py-2 rounded-md transition-colors">
            关闭页面
        </button>
    </div>
    
    <!-- 二维码过期页面 -->
    <div id="qrExpiredContainer" class="hidden fixed inset-0 flex flex-col justify-center items-center bg-white z-50 p-6 text-center">
        <div class="text-red-500 text-6xl mb-6">❌</div>
        <h3 class="text-2xl font-bold text-gray-800 mb-3">二维码已过期</h3>
        <p class="text-gray-600 mb-6 max-w-md">此二维码已超过10分钟有效期，请重新扫描最新的二维码。</p>
        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-6 max-w-md">
            <p class="text-sm text-yellow-700">
                二维码每10分钟自动刷新一次，请确保扫描的是最新的二维码
            </p>
        </div>
        <button id="closeQrBtn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-6 py-2 rounded-md transition-colors">
            关闭页面
        </button>
    </div>
    
    <!-- 引导模式页面 -->
    <div id="guideMask" class="guide-mask hidden">
        <header class="guide-title">
            <h1>请在浏览器中打开</h1>
        </header>
        <div class="demo">
            <div class="container">
                <div class="row">
                    <div class="col-md-12">
                        <div class="loader-guide">
                            <div class="loading-1"></div>
                            <div class="loading-2">请点击右上角选择"在浏览器中打开"</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 错误信息页面 -->
    <div id="errorContainer" class="hidden fixed inset-0 flex flex-col justify-center items-center bg-white z-50 p-6 text-center">
        <i id="errorIcon" class="fa fa-exclamation-triangle text-yellow-500 text-5xl mb-4"></i>
        <h3 class="text-xl font-semibold text-gray-700 mb-2">访问受限</h3>
        <p id="errorMessage" class="text-gray-500 mb-6">加载失败，请重试</p>
        <button id="retryBtn" class="bg-green-500 hover:bg-green-600 text-white px-6 py-2 rounded-md transition-colors">
            重试
        </button>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css"></script>
    <script>
        // 内容信息存储
        let currentContent = {
            url: '',
            title: '',
            subtitle: '',
            cover_image: '',
            method: 'embed'
        };
        
        // 1. 提取参数（支持token和id）
        function extractParamsFromUrl() {
            const params = new URLSearchParams(window.location.search);
            let token = params.get('token');
            let id = params.get('id');
            
            // 如果没有token，尝试从URL路径中提取id
            if (!token && !id) {
                const pathMatch = window.location.href.match(/id=(\d+)|(\d+)(?=\.\w+$)/);
                if (pathMatch) id = pathMatch[1] || pathMatch[2];
            }
            
            return {
                token: token,
                id: id ? parseInt(id, 10) : null
            };
        }
        
        // 2. 验证token有效性
        async function validateToken(token) {
            if (!token) return { valid: false, reason: '缺少token参数' };
            
            try {
                updateLoadProgress('正在验证二维码有效性...');
                
                // 调用API验证token
                const apiUrl = `https://wywfh.com/api.php?action=get_url&token=${encodeURIComponent(token)}`;
                
                // 设置请求超时（8秒）
                const timeoutPromise = new Promise((_, reject) => 
                    setTimeout(() => reject(new Error('验证超时')), 8000)
                );
                
                const response = await Promise.race([fetch(apiUrl), timeoutPromise]);
                const result = await response.json();
                
                if (result.success) {
                    return { 
                        valid: true, 
                        data: result.data,
                        linkId: result.data.id
                    };
                } else {
                    // 根据错误消息判断是否是token过期
                    if (result.message.includes('二维码已过期') || result.message.includes('token')) {
                        return { 
                            valid: false, 
                            reason: 'token_expired',
                            message: result.message
                        };
                    } else {
                        return { 
                            valid: false, 
                            reason: 'other',
                            message: result.message
                        };
                    }
                }
            } catch (error) {
                console.error('Token验证失败:', error);
                return { 
                    valid: false, 
                    reason: 'network_error',
                    message: error.message
                };
            }
        }
        
        // 3. 更新页面元数据
        function updatePageMetadata(data) {
            const title = data.title || '内容加载中...';
            const desc = data.subtitle || '正在加载内容...';
            document.getElementById('pageTitle').textContent = title;
            document.getElementById('ogTitle').content = title;
            document.getElementById('metaDescription').content = desc;
            document.getElementById('ogDescription').content = desc;
            if (data.cover_image) {
                document.getElementById('ogImage').content = data.cover_image;
                document.getElementById('favicon').href = data.cover_image;
                currentContent.cover_image = data.cover_image;
            }
            currentContent.title = title;
            currentContent.subtitle = desc;
        }
        
        // 4. 更新加载进度
        function updateLoadProgress(message) {
            document.getElementById('loadProgress').textContent = message;
        }
        
        // 5. 处理内嵌模式
        async function handleEmbedMode(url) {
            const contentFrame = document.getElementById('contentFrame');
            const loaderContainer = document.getElementById('loaderContainer');
            const contentContainer = document.getElementById('contentContainer');
            
            return new Promise((resolve, reject) => {
                // 超时设置（15秒）
                const timeout = setTimeout(() => {
                    reject(new Error('内容加载超时'));
                }, 15000);
                
                // 加载完成回调
                contentFrame.onload = () => {
                    clearTimeout(timeout);
                    loaderContainer.classList.add('hidden');
                    contentContainer.classList.remove('hidden');
                    resolve(true);
                };
                
                // 加载失败回调
                contentFrame.onerror = () => {
                    clearTimeout(timeout);
                    reject(new Error('内容加载失败'));
                };
                
                // 设置iframe源
                updateLoadProgress('正在加载内容...');
                contentFrame.src = url;
            });
        }
        
        // 6. 处理引导模式
        function handleRedirectMode(url) {
            const guideMask = document.getElementById('guideMask');
            const loaderContainer = document.getElementById('loaderContainer');
            
            // 显示引导页，隐藏加载状态
            loaderContainer.classList.add('hidden');
            guideMask.classList.remove('hidden');
            
            // 3秒后自动跳转
            setTimeout(() => {
                window.location.href = url;
            }, 3000);
            
            return false;
        }
        
        // 7. 主逻辑：根据API返回的模式处理
        async function processContent() {
            const { url, method } = currentContent;
            
            if (method === 'redirect') {
                // 引导模式
                return handleRedirectMode(url);
            } else {
                // 内嵌模式
                return handleEmbedMode(url);
            }
        }
        
        // 页面初始化
        document.addEventListener('DOMContentLoaded', () => {
            loadContent();
            // 重试按钮事件
            document.getElementById('retryBtn').addEventListener('click', loadContent);
            // 关闭按钮事件
            document.getElementById('closeBtn').addEventListener('click', () => {
                if (window.close) {
                    window.close();
                } else {
                    document.getElementById('expiredContainer').classList.add('hidden');
                }
            });
            // 二维码过期关闭按钮
            document.getElementById('closeQrBtn').addEventListener('click', () => {
                if (window.close) {
                    window.close();
                } else {
                    document.getElementById('qrExpiredContainer').classList.add('hidden');
                    window.location.href = 'https://wywfh.com/';
                }
            });
        });
        
        // 8. 加载内容主函数
        async function loadContent() {
            // 初始化DOM元素
            const loader = document.getElementById('loaderContainer');
            const errorContainer = document.getElementById('errorContainer');
            const expiredContainer = document.getElementById('expiredContainer');
            const qrExpiredContainer = document.getElementById('qrExpiredContainer');
            const [errorIcon, errorMessage] = [
                document.getElementById('errorIcon'),
                document.getElementById('errorMessage')
            ];
            const expiryDetail = document.getElementById('expiryDetail');
            
            // 重置所有状态
            loader.classList.remove('hidden');
            [errorContainer, expiredContainer, qrExpiredContainer].forEach(el => el.classList.add('hidden'));
            
            // 提取参数
            const { token, id } = extractParamsFromUrl();
            
            // 如果没有token也没有id，显示错误
            if (!token && !id) {
                setTimeout(() => {
                    loader.classList.add('hidden');
                    errorIcon.className = 'fa fa-exclamation-triangle text-yellow-500 text-5xl mb-4';
                    errorMessage.textContent = '未找到有效的访问参数，请检查链接';
                    errorContainer.classList.remove('hidden');
                }, 500);
                return;
            }
            
            try {
                updateLoadProgress('正在请求资源信息...');
                
                let result;
                
                // 如果有token，先验证token
                if (token) {
                    const tokenValidation = await validateToken(token);
                    
                    if (!tokenValidation.valid) {
                        // token无效或过期
                        if (tokenValidation.reason === 'token_expired') {
                            loader.classList.add('hidden');
                            qrExpiredContainer.classList.remove('hidden');
                            return;
                        } else {
                            throw new Error(tokenValidation.message || '二维码验证失败');
                        }
                    }
                    
                    // token验证成功，使用返回的数据
                    result = { success: true, data: tokenValidation.data };
                    updateLoadProgress('二维码验证成功，正在加载内容...');
                } else {
                    // 使用传统的ID方式
                    const apiUrl = `https://wywfh.com/api.php?action=get_url&id=${id}`;
                    
                    // 设置请求超时（10秒）
                    const timeoutPromise = new Promise((_, reject) => 
                        setTimeout(() => reject(new Error('连接超时')), 10000)
                    );
                    const response = await Promise.race([fetch(apiUrl), timeoutPromise]);
                    result = await response.json();
                }
                
                // 处理API返回的错误
                if (!result.success) {
                    if (result.message === "该链接已过期") {
                        // 链接过期处理
                        expiryDetail.textContent = result.data?.expiry_time 
                            ? `该链接已于 ${result.data.expiry_time} 过期` 
                            : "该链接已过期，请联系提供者获取新链接";
                        loader.classList.add('hidden');
                        expiredContainer.classList.remove('hidden');
                        return;
                    }
                    // 其他错误
                    throw new Error(result.message || '请求失败');
                }
                
                // 验证内容链接是否存在
                if (!result.data?.original_url) {
                    throw new Error('未找到对应的内容链接');
                }
                
                // 存储内容信息
                currentContent = {
                    url: result.data.original_url,
                    title: result.data.title || '',
                    subtitle: result.data.subtitle || '',
                    cover_image: result.data.cover_image || '',
                    method: result.data.method || 'embed'
                };
                
                // 更新页面元数据
                updatePageMetadata(result.data);
                
                // 处理内容展示
                updateLoadProgress(`正在${currentContent.method === 'embed' ? '加载' : '引导'}内容...`);
                await processContent();
                
            } catch (error) {
                console.error('加载失败:', error);
                loader.classList.add('hidden');
                
                // 处理其他错误
                const errorText = error.message.includes('超时') 
                    ? '操作超时，请检查网络连接' 
                    : error.message.includes('未找到') 
                        ? `未找到对应的内容` 
                        : `加载失败: ${error.message}`;
                
                errorIcon.className = 'fa fa-exclamation-triangle text-yellow-500 text-5xl mb-4';
                errorMessage.textContent = errorText;
                errorContainer.classList.remove('hidden');
            }
        }
    </script>
</body>
</html>
